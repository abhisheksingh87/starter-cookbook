+++
categories = ["recipes"]
tags = ["application development", "kafka","topics", "functional", "reactor", "spring cloud stream", "spring kafka","spring webflux"]
summary = "Spring Cloud Streams functional and reactive"
title = "Spring Cloud Streams functional and reactive"
date = "2021-02-04T09:50:27-06:00"
weight = 102
type="kafka-recipes"
+++

## CONTEXT

This recipe walks you through the process of how to configure spring cloud streams using [Spring Cloud Functions](https://spring.io/projects/spring-cloud-function)

## Prerequisites


- **STEP 1:** Create Application using Spring-Cloud-Stream-Starter is completed.
- **STEP 2:** Java 8 or above installed
- **STEP 3:** Kafka broker (Zookeeper, Server) is setup and running.
- **STEP 4:** Sample Kafka topic (card-events) is created with 1 partition


## Spring Cloud Stream Functions
{{%notice note%}} _Anything you can do with **@StreamListener/@EnableBinding** you can also do without it. 
In other words, the functional support is now feature-compatible with the annotation-based support_. {{%/notice%}}

### Supplier, Function and Consumer

Any bean of type `Supplier`, `Function`, or `Consumer` or any bean that could be mapped to Supplier, Function, or Consumer 
(such as a POJO function, lambdas, and so on) is treated by _SCSt_ as a **message handler** (Function or Consumer ) or **message source** (Supplier). 
Based on the type of functional strategy used, input and output bindings are automatically generated by using the following naming convention:  
**{function-name}**-**{in/out}**-**{index}**.


## Create Producer And Consumer

1. Add below configuration in `src/main/resource/application.yml`:

    ```yaml
    spring:
      cloud:
        stream:
          function:
            definition: cardSupplier;cardEventConsumer
          bindings:
              cardSupplier-out-0:
                  destination: card-events
              cardEventConsumer-in-0:
                  destination: card-events  
                  group: card-group
                  concurrency: 2 
    ```
   * **spring.cloud.stream.function.definition:**  specifies functional bean which is used to bind to the external destination(s) exposed by the _bindings_
   * **spring.cloud.stream.bindings** is used to supply binding properties are supplied using the format _spring.cloud.stream.bindings.bean-name-in/out-index_
   * **Bindings:**
     * A binding is defined as either an input or output by virtue of having **-in** or **-out** following the function name within the binding.
     * A binding also has a **sequence number**, allowing multiple bindings to be chained.
     * A binding defines a **destination**. The destination is the topic the message is read from or written to. {{%notice note%}} Even a consumer calls its topic a destination.{{%/notice%}}
     * Each binding also demonstrates basic configuration, such as **consumer groups**, **concurrency**, **retry**, and **backoff**. The retry configuration also defines particular exceptions which should not be retried. 

1. Add `CreditCardConfig` class and Create _Supplier_ and _Consumer_  `Bean` like below:

    ```java
    @Bean
    public Supplier<Flux<CardEvent>> cardSupplier(Sinks.Many<CardEvent> sink){
       return sink::asFlux;
    }
    
    @Bean
    public Consumer<CardEvent> cardEventConsumer(){
      return cardEvent -> cardStatusUpdateEventHandler.updateCardStatus(cardEvent.getCreditCardDto());
    }
   
    @Bean
    public Function<Flux<String>, Flux<String>> uppercase() {
       return flux -> flux.map(String::toUpperCase);
    }
    ```
   
   * **Sinks:** are constructs through which Reactive Streams signals can be programmatically pushed, with `Flux` or `Mono` semantics. 
   These standalone sinks expose `tryEmit` methods that return an `Sinks.EmitResult` _enum_, allowing to atomically fail in case 
   the attempted signal is inconsistent with the spec and/or the state of the sink.

## Create Service:

1. Create `CreditCardPublisher` class which will emit/send CreditCard Event to the Topic:

    ```java
    @Service
    @AllArgsConstructor
    public class CreditCardPublisher {
    
        private final Sinks.Many<CardEvent> cardSink;
    
        public void raiseCardEvent(final Customer customer, CardStatus cardStatus){
            var creditCardDto = CreditCardDto.of(
                    UUID.randomUUID(),
                    CardType.VISA,
                    customer.getIncome(),
                    null,
                    customer.getCustomerId().toString(),
                    cardStatus
            );
            var cardEvent = new CardEvent(creditCardDto, cardStatus);
            this.cardSink.tryEmitNext(cardEvent);
        }
    
    }
    ```

1. Create `CreditCardStatusUpdateService` class which will consume `CreditCardEvent` and log data:

    ```java
    @Service
    @Slf4j
    public class CardStatusUpdateEventHandler {
    
        public void updateCardStatus(CreditCardDto creditCardDto){
            log.info("Consumed Card Details: {}", creditCardDto);
    
        }
    }
    ```

## Create REST API

1. Create a REST API endpoint that will trigger sending a message to Kafka using the ```CreditCardPublisher``` class:

    ```java
    @RestController
    public class CustomerController {
    
        @Autowired
        private CustomerService customerService;
    
        @GetMapping("/customer")
        @ResponseStatus(HttpStatus.ACCEPTED)
        public ResponseEntity<Customer> customer(@RequestBody Customer Customer) {
            customer.setCustomerId(UUID.randomUUID());
             this.creditCardPublisher.raiseCardEvent(customer, CardStatus.CARD_VERIFYING);
             return ResponseEntity.ok(customer);
        }
    
    }
    ```
### Running Application

1. Use a rest client to send _Customer_ object like below:

    ```json
    {
        "firstName": "alex",
        "lastName": "smith",
        "social": "180-00-000",
        "income": "100000"
    }
    ```

1. You should see below console output:

    ```shell script
    [container-0-C-1] e.s.c.s.e.e.CardStatusUpdateEventHandler : Consumed Card Details: CreditCardDto(id=65e40f71-20ba-4073-bd30-5b6113c820a4, cardType=VISA, customerIncome=100000, amountLimit=null, customerId=367363c2-d8a8-43a4-beca-6ed7ff77590b, cardStatus=CARD_VERIFYING)
    ```

The source code is available at: [WF Github](http://hop.hosting.wellsfargo.com/spring-cloud-stream-fun)
